<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>BDD</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="markdown-pandoc-amV4.css" />
  <link rel="icon" href="favicon.ico" />
  <title>BDD</title>
</head>
<body>
<h1 id="les-transactions-en-bdd">les transactions en BDD</h1>
<p>Quand on développe un programme P accédant à une base de données, on
suppose que :</p>
<ul>
<li><p>P s’exécutera indépendamment de tout autre programme ou
utilisateur</p></li>
<li><p>l’exécution de P se déroulera toujours intégralement.</p></li>
</ul>
<p>Or les bases de données constituent des ressources accessibles
simultanément à plusieurs utilisateurs pour rechercher, créer, modifier
ou détruire des informations :</p>
<p><strong>les accès simultanés à une même ressource sont dits
concurrents</strong> =&gt; <strong>contrôle de concurrence</strong></p>
<p>Il existe une multitude de raison qu’un programme ne se déroule pas
intégralement (arrêt des serveurs, erreurs de code, violation de
contrainte …) =&gt; <strong>reprise sur panne</strong></p>
<p><a href="http://sql.bdpedia.fr/transactions.html"
target="_blanck">http://sql.bdpedia.fr/transactions.html</a> <br></p>
<ul>
<li>Définition des points de sauvegardes.(commit)</li>
<li>Blocages des autres utilisateurs. Le contrôle de concurrence =&gt;
verrouillage de certaines resources (tables blocs, n-uplets)</li>
<li>Choix d’un niveau d’isolation</li>
</ul>
<p><br></p>
<h1 id="les-bases">les bases</h1>
<p>DELETE UPDATE INSERT : <strong>ce sont des instructions
transactionnelles atomiques (elles fonctionnent complètement ou pas du
tout)</strong></p>
<p>Le concept de transaction sur un compte (bancaire …)</p>
<ul>
<li>on désire :
<ul>
<li>retirer 1000€ sur le compte de ref 111111</li>
<li>rajouter 1000€ sur le compte de ref 222222</li>
<li>enregistrer l’information : ‘M Dupond’ a déplacé de l’argent (1000€)
de son compte 111111 à son compte 222222</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb1"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">UPDATE</span> sb_accounts <span class="kw">SET</span> balance <span class="op">=</span> balance <span class="op">-</span> <span class="dv">1000</span> <span class="kw">WHERE</span> account_no <span class="op">=</span> <span class="dv">111111</span> ; </span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="kw">UPDATE</span> ca_accounts <span class="kw">SET</span> balance <span class="op">=</span> balance <span class="op">+</span> <span class="dv">1000</span> <span class="kw">WHERE</span> account_no <span class="op">=</span> <span class="dv">222222</span> ; </span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> journal <span class="kw">VALUES</span> (<span class="dv">100896</span>, <span class="st">&#39;Transfert de M Dupond &#39;</span>, <span class="st">&#39;2017-01-01&#39;</span>, <span class="dv">111111</span>, <span class="dv">222222</span>, <span class="dv">1000</span>); </span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="kw">COMMIT</span> <span class="kw">WORK</span>;</span></code></pre></div>
<ul>
<li>Si pour une raison quelconque entre les 2 “UPDATE” la session est
stoppée, l’argent serait perdu !</li>
</ul>
<p>documentation : “<a
href="http://mysql.developpez.com/faq/?page=Transactions"
target="_blanck">doc developpez.com</a>” “<a
href="http://docs.postgresql.fr/8.2/tutorial-transactions.html"
target="_blanck">doc postgreSQL</a>”</p>
<p><br>
<!-- [doc openclassroom](https://openclassrooms.com/courses/administrez-vos-bases-de-donnees-avec-mysql/transactions){target="_blanck"} --></p>
<ul>
<li>Tester les instructions ci dessous :</li>
</ul>
<div class="sourceCode" id="cb2"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">DROP</span> <span class="kw">TABLE</span> <span class="cf">IF</span> <span class="kw">EXISTS</span> td_Client;</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> td_Client (</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    id_client <span class="dt">INTEGER</span>  <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    nom <span class="dt">varchar</span>(<span class="dv">30</span>)  <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    nb_places_reservees <span class="dt">INTEGER</span>  <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    solde <span class="dt">INTEGER</span>  <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">PRIMARY</span> <span class="kw">KEY</span> (id_client)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">into</span> td_Client <span class="kw">VALUES</span> (<span class="dv">1</span>, <span class="st">&#39;Philippe&#39;</span>, <span class="dv">0</span>, <span class="dv">2000</span>);</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">into</span> td_Client <span class="kw">VALUES</span> (<span class="dv">2</span>, <span class="st">&#39;Julie&#39;</span>, <span class="dv">0</span>, <span class="dv">350</span>);</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">into</span> td_Client <span class="kw">VALUES</span> (<span class="dv">3</span>, <span class="st">&#39;alex&#39;</span>, <span class="dv">0</span>, <span class="dv">350</span>);</span></code></pre></div>
<div class="sourceCode" id="cb3"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> @@autocommit;</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">UPDATE</span> td_Client <span class="kw">SET</span> nom<span class="op">=</span><span class="ot">&quot;ALEXANDRE&quot;</span> <span class="kw">WHERE</span> id_client<span class="op">=</span><span class="dv">3</span>;</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> autocommit<span class="op">=</span><span class="dv">0</span>;  <span class="co">-- Les &quot;COMMIT&quot; ne sont plus automatiques</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> td_Client <span class="kw">WHERE</span> id_client<span class="op">=</span><span class="dv">3</span>;</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="kw">START</span> <span class="kw">TRANSACTION</span>;</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="kw">UPDATE</span> td_Client <span class="kw">SET</span> nom<span class="op">=</span><span class="ot">&quot;alex1&quot;</span> <span class="kw">WHERE</span> id_client<span class="op">=</span><span class="dv">3</span>;</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> td_Client <span class="kw">WHERE</span> id_client<span class="op">=</span><span class="dv">3</span>;</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="kw">ROLLBACK</span>;</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> td_Client <span class="kw">WHERE</span> id_client<span class="op">=</span><span class="dv">3</span>;</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="kw">UPDATE</span> td_Client <span class="kw">SET</span> nom<span class="op">=</span><span class="ot">&quot;alex2&quot;</span> <span class="kw">WHERE</span> id_client<span class="op">=</span><span class="dv">3</span>;</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> td_Client <span class="kw">WHERE</span> id_client<span class="op">=</span><span class="dv">3</span>;</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="co">-- se connecter depuis un autre terminal sur cette base de données (nouvelle session) ; qu&#39;elle est la valeur du champ nom ?</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="kw">COMMIT</span>;</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> td_Client <span class="kw">WHERE</span> id_client<span class="op">=</span><span class="dv">3</span>;</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a><span class="kw">ROLLBACK</span>;</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> td_Client <span class="kw">WHERE</span> id_client<span class="op">=</span><span class="dv">3</span>;</span></code></pre></div>
<ul>
<li>l’instruction “START TRANSACTION;” est elle obligatoire pour faire
une transaction (revenir en arrière avant le COMMIT) ?</li>
<li>lorsqu’une transaction est démarrée, peut on voir les changements
depuis une autre session avant le “COMMIT” ?</li>
</ul>
<p><br></p>
<ul>
<li>Reprendre le script précédent, démarrer la transaction, modifier la
valeur du <strong>nom</strong>.</li>
<li>Ouvrir un autre terminal sur la même base de données : une
<strong>autre session</strong>, exécuter l’instruction ci-dessous</li>
</ul>
<div class="sourceCode" id="cb4"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> @@autocommit;</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> td_Client <span class="kw">WHERE</span> id_client<span class="op">=</span><span class="dv">3</span>;</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="kw">UPDATE</span> td_Client <span class="kw">SET</span> nom<span class="op">=</span><span class="ot">&quot;alex ***** 1&quot;</span> <span class="kw">WHERE</span> id_client<span class="op">=</span><span class="dv">3</span>;</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> td_Client <span class="kw">WHERE</span> id_client<span class="op">=</span><span class="dv">3</span>;</span></code></pre></div>
<ul>
<li>terminer la première transaction, … conclusion</li>
</ul>
<p><br></p>
<p><strong>CONCLUSION</strong> : Propriétés des transactions : ACIDité
[Harder&amp;Reuter, ACM CS 15(4), 1983]</p>
<ul>
<li>Atomicité : Toutes les MAJ sont exécutées ou aucune</li>
<li>Cohérence : Passer d’un état cohérent à un autre (pas géré par le
système)</li>
<li>Isolation : La transaction s’effectue comme si elle était seule</li>
<li>Durabilité : Une fois une transactions validée, son effet ne peut
pas être perdu suite à une panne quelconque.</li>
</ul>
<p><a
href="https://makina-corpus.com/devops/bien-debuter-avec-les-transactions-sql"
target="_blanck">https://makina-corpus.com/devops/bien-debuter-avec-les-transactions-sql</a>
<br> <a href="http://sys.bdpedia.fr/transactions.html"
target="_blanck">http://sys.bdpedia.fr/transactions.html</a> <a
href="https://sgbd.developpez.com/tutoriels/cours-complet-bdd-sql/?page=concurrence-et-reprise#LXI"
target="_blanck">https://sgbd.developpez.com/tutoriels/cours-complet-bdd-sql/?page=concurrence-et-reprise#LXI</a></p>
<p><a
href="https://zestedesavoir.com/tutoriels/730/administrez-vos-bases-de-donnees-avec-mysql/952_securiser-et-automatiser-ses-actions/3952_transactions/"
target="_blanck">https://zestedesavoir.com/tutoriels/730/administrez-vos-bases-de-donnees-avec-mysql/952_securiser-et-automatiser-ses-actions/3952_transactions/</a>
<br></p>
<h1 id="exercice-transaction">exercice transaction</h1>
<div class="sourceCode" id="cb5"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">DROP</span> <span class="kw">TABLE</span> <span class="cf">IF</span> <span class="kw">EXISTS</span> td_Spectacle, td_Journal;</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> td_Spectacle (</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    id_spectacle <span class="dt">INTEGER</span>  <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    titre <span class="dt">VARCHAR</span>(<span class="dv">30</span>)  <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    nb_places_offertes <span class="dt">INTEGER</span>  <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">CHECK</span>(nb_places_offertes<span class="op">&gt;=</span><span class="dv">0</span>),</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    nb_places_libres <span class="dt">INTEGER</span>  <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">CHECK</span>(nb_places_libres<span class="op">&gt;=</span><span class="dv">0</span>),</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    tarif <span class="dt">DECIMAL</span>(<span class="dv">10</span>,<span class="dv">2</span>)  <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">PRIMARY</span> <span class="kw">KEY</span> (id_spectacle)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> td_Journal (</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">id</span> <span class="dt">INTEGER</span>  AUTO_INCREMENT,</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    libelle_transaction <span class="dt">VARCHAR</span>(<span class="dv">30</span>)  <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    client_id <span class="dt">INTEGER</span>,</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    nb_places <span class="dt">INTEGER</span>,</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    spectacle_id <span class="dt">INTEGER</span>,</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    tarif <span class="dt">DECIMAL</span>(<span class="dv">19</span>,<span class="dv">4</span>),</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">PRIMARY</span> <span class="kw">KEY</span> (<span class="kw">id</span>)</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> autocommit <span class="op">=</span> <span class="dv">0</span>;</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a><span class="kw">DELETE</span> <span class="kw">FROM</span> td_Client;</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a><span class="kw">DELETE</span> <span class="kw">FROM</span> td_Spectacle;</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">into</span> td_Client <span class="kw">VALUES</span> (<span class="dv">1</span>, <span class="st">&#39;Philippe&#39;</span>, <span class="dv">0</span>, <span class="dv">2000</span>);</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">into</span> td_Client <span class="kw">VALUES</span> (<span class="dv">2</span>, <span class="st">&#39;Julie&#39;</span>, <span class="dv">0</span>, <span class="dv">350</span>);</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">into</span> td_Spectacle <span class="kw">VALUES</span> (<span class="dv">1</span>, <span class="st">&#39;Ben hur&#39;</span>, <span class="dv">250</span>, <span class="dv">50</span>, <span class="dv">50</span>);</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">into</span> td_Spectacle <span class="kw">VALUES</span> (<span class="dv">2</span>, <span class="st">&#39;Tartuffe&#39;</span>, <span class="dv">120</span>, <span class="dv">30</span>, <span class="dv">30</span>);</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a><span class="kw">COMMIT</span>;</span></code></pre></div>
<ul>
<li>faire un premier script (transaction le client “1” achete 20 places
de ‘Ben hur’)
<ul>
<li>décrémenter le nombre de places libres de 20 dans la table
“td_Spectacle”</li>
<li>incrémenter de 20 la colonne “nb_places_reservees” dans la table
“td_Client”</li>
<li>calculer le prix des places</li>
<li>écrire dans la table “td_Journal” : ‘achat de place’, l’identifiant
du client et du spectacle ainsi que les prix des places</li>
</ul></li>
</ul>
<p>utiliser les variables en début de script (nb_place, spectacle_id et
client_id)</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> @nb_place<span class="op">=</span><span class="dv">20</span>;</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> @spectacle_id<span class="op">=</span><span class="dv">1</span>;</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> @client_id<span class="op">=</span><span class="dv">1</span>;</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> autocommit <span class="op">=</span> <span class="dv">0</span>;</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="kw">START</span> <span class="kw">TRANSACTION</span>;</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> @nb_place,@spectacle_id,@client_id;</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co">-- à compléter</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="co">-- à compléter</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="co">-- à compléter</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="co">-- à compléter</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> td_Spectacle;</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> td_Client;</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> td_Journal;</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a><span class="kw">COMMIT</span>;</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> td_Spectacle;</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> td_Client;</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> td_Journal;</span></code></pre></div>
<p>REMARQUE : lors du COMMIT toutes les opérations valides sont
exécutées =&gt; programme pour vérifier l’intégrité des données</p>
<p><a href="http://sql.bdpedia.fr/transactions.html#s1-transactions"
target="_blanck">http://sql.bdpedia.fr/transactions.html#s1-transactions</a>
<br></p>
<h1 id="les-verrous">les verrous</h1>
<pre><code>LOCK TABLES nom_table [AS alias_table]  [READ  | WRITE]   [,....];</code></pre>
<ul>
<li>En utilisant <strong>READ</strong> : verrou en lecture, les autres
sessions pourront que lire les données des tables verrouillées, mais ne
pourront pas les modifier (<strong>SELECT uniquement</strong>)</li>
<li>En utilisant <strong>WRITE</strong> : verrou en écriture, les autres
sessions pourront ni lire ni modifié les données des tables
verrouillées.</li>
</ul>
<p>Conséquence de l’utilisation de verrou :</p>
<ul>
<li><p><strong>Accès uniquement au table verrouillée</strong></p></li>
<li><p><strong>Lorsqu’une session MySQL pose un verrou sur un élément de
la base de données, cela veut dire qu’il restreint, voire interdit,
l’accès à cet élément aux autres sessions MySQL qui voudraient y
accéder</strong>.</p></li>
</ul>
<p><strong>session 1 (terminal)</strong></p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">LOCK</span> <span class="kw">TABLES</span> td_Client   <span class="kw">READ</span>,              <span class="co">-- On pose un verrou de lecture sur td_Client</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>            td_Spectacle  <span class="kw">WRITE</span>;           <span class="co">-- et un verrou d&#39;écriture sur td_Spectacle</span></span></code></pre></div>
<p>exécuter les 3 requêtes ci-dessous dans 2 terminaux</p>
<p><strong>session 1 et Session 2 (terminal)</strong></p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> td_Client;</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> td_Journal;</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> td_Spectacle;</span></code></pre></div>
<p><strong>session 1 et Session 2 (terminal)</strong></p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">UPDATE</span> td_Client <span class="kw">SET</span> nb_places_reservees <span class="op">=</span> <span class="dv">1</span>  <span class="kw">WHERE</span> id_client<span class="op">=</span><span class="dv">1</span>;</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="kw">UPDATE</span> td_Spectacle <span class="kw">SET</span> nb_places_libres <span class="op">=</span> <span class="dv">2</span> <span class="kw">WHERE</span> id_spectacle<span class="op">=</span><span class="dv">1</span>;</span></code></pre></div>
<p><strong>session 1 (terminal)</strong></p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">UNLOCK</span> <span class="kw">TABLES</span>  ;</span></code></pre></div>
<p>Verrous de TABLE et verrous de ligne Il est possible de poser un
verrou sur une TABLE entière, ou seulement sur une ou plusieurs lignes
d’une TABLE. Étant donné qu’un verrou empêche l’accès d’autres sessions,
il est en général plus intéressant de poser un verrou sur la plus petite
partie de la base possible.</p>
<p><br></p>
<p>Cette notion d’accès simultané aux données par plusieurs sessions
différentes s’appelle la concurrence. Plus la concurrence est possible,
donc plus le nombre de sessions pouvant accéder aux données
simultanément est grand, mieux c’est. En effet, prenons l’exemple d’un
site web. En général, on préfère permettre à plusieurs utilisateurs de
surfer en même temps, sans devoir attendre entre chaque action de
pouvoir accéder aux informations chacun à son tour. Or, chaque
utilisateur crée une session chaque fois qu’il se connecte à la base de
données (pour lire les informations ou les modifier). Préférez donc
(autant que possible) les verrous de ligne aux verrous de TABLE !</p>
<p><br></p>
<p><strong>Conséquences pour les autres sessions</strong></p>
<p>Si une session a obtenu un <strong>verrou de lecture</strong> sur une
TABLE, les autres sessions :</p>
<ul>
<li>peuvent lire les données de la TABLE ;</li>
<li>peuvent également acquérir un verrou de lecture sur cette TABLE
;</li>
<li>ne peuvent pas modifier les données, ni acquérir un verrou
d’écriture sur cette TABLE.</li>
</ul>
<p>Si par contre une session a obtenu un <strong>verrou
d’écriture</strong>, les autres sessions ne peuvent absolument pas
accéder à cette TABLE tant que ce verrou existe.</p>
<h2 id="verrou-mortel">Verrou mortel</h2>
<div class="sourceCode" id="cb12"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> autocommit <span class="op">=</span> <span class="dv">0</span>;</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="kw">START</span> <span class="kw">TRANSACTION</span>;</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="ot">&quot;P1&quot;</span>;</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> SLEEP(<span class="dv">15</span>);</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="kw">UPDATE</span> td_Client <span class="kw">SET</span> nom<span class="op">=</span><span class="ot">&quot;alexandre 1&quot;</span> <span class="kw">WHERE</span> id_client<span class="op">=</span><span class="dv">1</span>;</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> SLEEP(<span class="dv">15</span>);</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="kw">UPDATE</span> td_Spectacle <span class="kw">SET</span> titre<span class="op">=</span><span class="ot">&quot;Ben hur 1&quot;</span> <span class="kw">WHERE</span> id_spectacle<span class="op">=</span><span class="dv">1</span>; </span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="co">-- lancer l&#39;autre script dans un terminal</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="ot">&quot;P1&quot;</span>;</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="kw">COMMIT</span>; </span></code></pre></div>
<div class="sourceCode" id="cb13"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> autocommit <span class="op">=</span> <span class="dv">0</span>;</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="kw">START</span> <span class="kw">TRANSACTION</span>;</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="ot">&quot;P2&quot;</span>;</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="kw">UPDATE</span> td_Spectacle <span class="kw">SET</span> titre<span class="op">=</span><span class="ot">&quot;Ben hur 2&quot;</span> <span class="kw">WHERE</span> id_spectacle<span class="op">=</span><span class="dv">1</span>;</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> SLEEP(<span class="dv">15</span>);</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="kw">UPDATE</span> td_Client <span class="kw">SET</span> nom<span class="op">=</span><span class="ot">&quot;alexandre 2&quot;</span> <span class="kw">WHERE</span> id_client<span class="op">=</span><span class="dv">1</span>;</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="ot">&quot;P2&quot;</span>;</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="kw">COMMIT</span>; </span></code></pre></div>
<!--
```sql
SELECT * FROM td_Client WHERE id_client=2 OR id_client=3 ;

SET autocommit = 0;
START TRANSACTION;
SELECT SLEEP(15);
UPDATE td_Client SET nom="alexandre" WHERE id_client=2;
SELECT * FROM td_Client WHERE id_client=2 OR id_client=3 ;  -- --
SELECT SLEEP(15);
UPDATE td_Client SET nom="alex" WHERE id_client=3;         -- --
SELECT * FROM td_Client WHERE id_client=2 OR id_client=3 ;

-- lancer l'autre script dans un terminal
COMMIT;

SELECT * FROM td_Client WHERE id_client=2 OR id_client=3 ;
```

```sql
SELECT * FROM td_Client WHERE id_client=2 OR id_client=3 ;

SET autocommit = 0;
START TRANSACTION;
UPDATE td_Client SET nom="alex1" WHERE id_client=3;        -- --
SELECT * FROM td_Client WHERE id_client=2 OR id_client=3 ;
SELECT SLEEP(15);
UPDATE td_Client SET nom="alexandre1" WHERE id_client=2;   -- --
SELECT * FROM td_Client WHERE id_client=2 OR id_client=3 ;
COMMIT;

SELECT * FROM td_Client WHERE id_client=2 OR id_client=3 ;
```
-->
<p><code>SHOW VARIABLES  LIKE 'innodb_lock_wait_timeout';</code> <a
href="https://mariadb.com/kb/en/innodb-system-variables/#innodb_lock_wait_timeout"
target="_blanck">doc</a></p>
<p><code>SHOW GLOBAL VARIABLES LIKE 'innodb_rollback_on_timeout';</code></p>
<p><a
href="https://docs.microsoft.com/fr-fr/sql/relational-databases/sql-server-transaction-locking-and-row-versioning-guide?view=sql-server-ver15#deadlocks"
target="_blanck">interblocage (deadlocks)</a></p>
<h1 id="autres-moyens-de-verrouillage">autres moyens de
verrouillage</h1>
<div class="sourceCode" id="cb14"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> td_Spectacle <span class="kw">WHERE</span> id_spectacle <span class="op">=</span> <span class="dv">1</span> <span class="kw">LOCK</span> <span class="kw">IN</span> <span class="kw">SHARE</span> <span class="kw">MODE</span>;</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="kw">UPDATE</span> td_Spectacle <span class="kw">SET</span> nb_places_libres<span class="op">=</span><span class="dv">5</span> <span class="kw">WHERE</span> id_spectacle <span class="op">=</span> <span class="dv">1</span>;</span></code></pre></div>
<p>: pose un verrou partagé sur la prochaine clé sur tous les index que
la lecture rencontre.</p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> td_Spectacle <span class="kw">WHERE</span> id_spectacle <span class="op">=</span> <span class="dv">1</span> <span class="cf">FOR</span> <span class="kw">UPDATE</span>;</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="kw">UPDATE</span> td_Spectacle <span class="kw">SET</span> nb_places_libres<span class="op">=</span><span class="dv">10</span> <span class="kw">WHERE</span> id_spectacle <span class="op">=</span> <span class="dv">1</span>;</span></code></pre></div>
<p>: pose un verrou exclusif sur la prochaine clé sur tous les index que
la lecture rencontre.</p>
<p><a
href="http://samisd2003.free.fr/WinLAMP/MYSQL/innodb-locking-reads.html"
target="_blanck">http://samisd2003.free.fr/WinLAMP/MYSQL/innodb-locking-reads.html</a>
<br></p>
<h1 id="niveau-disolation-transaction">niveau d’isolation
transaction</h1>
<p>niveau 0 : READ-UNCOMMITTED ; autorise la lecture sale</p>
<p>niveau 1 : READ-COMMITTED ; interdit la lecture sale</p>
<p><strong>niveau 2 : REPEATABLE-READ</strong> (niveau par défaut) ;
idem, et rend la session aveugle aux modifications (mêmes validées)
faites par les autres sessions (“lecture cohérente” ou consistent
read)</p>
<p>niveau 3 : SERIALIZABLE : idem, et fait comme si les transactions
étaient validées les unes après les autres et non en même temps</p>
<p><a href="https://blog.arbinada.com/category/01647.html"
target="_blanck">article sur MS SQLserver</a></p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> @@TX_ISOLATION;</span></code></pre></div>
<div class="sourceCode" id="cb17"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a># Et voici les commandes pour régler le niveau d<span class="st">&#39;isolation</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="st">SET session transaction isolation level read uncommitted;</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="st">SET session transaction isolation level read committed;</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="st">SET session transaction isolation level repeatable read;</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="st">SET session transaction isolation level serializable;</span></span></code></pre></div>
<p><a
href="https://dev.mysql.com/doc/refman/5.6/en/innodb-transaction-isolation-levels.html"
target="_blanck">https://dev.mysql.com/doc/refman/5.6/en/innodb-transaction-isolation-levels.html</a>
<br> <a
href="https://stackoverflow.com/questions/6121917/automatic-rollback-if-commit-transaction-is-not-reached"
target="_blanck">https://stackoverflow.com/questions/6121917/automatic-rollback-if-commit-transaction-is-not-reached</a></p>
<p>MySQL 8+
<code>SELECT @@transaction_isolation;        -- session</code><br />
<code>SELECT @@global.transaction_isolation; -- global</code></p>
<p><a href="https://mysql.developpez.com/faq/?page=Transactions"
target="_blanck">https://mysql.developpez.com/faq/?page=Transactions</a>
<br> <a
href="https://www.canal-u.tv/chaines/inria/transactions-et-concurrence/degres-d-isolation-dans-les-sgbd"
target="_blanck">https://www.canal-u.tv/chaines/inria/transactions-et-concurrence/degres-d-isolation-dans-les-sgbd</a></p>
<p><strong>article sympa :</strong></p>
<p><a
href="https://medium.com/neoxia/deepdive-voyage-au-pays-des-lock-mysql-innodb-2bb043f9739"
target="_blanck">https://medium.com/neoxia/deepdive-voyage-au-pays-des-lock-mysql-innodb-2bb043f9739</a>
<br></p>
<h1 id="procédure-et-fonction">procédure et fonction</h1>
<p><a
href="https://fr.wikibooks.org/wiki/MySQL/Proc%C3%A9dures_stock%C3%A9es"
target="_blanck">https://fr.wikibooks.org/wiki/MySQL/Proc%C3%A9dures_stock%C3%A9es</a>
<br></p>
<h1 id="gestion-dune-erreur">gestion d’une erreur</h1>
<div class="sourceCode" id="cb18"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>SIGNAL SQLSTATE <span class="st">&#39;45000&#39;</span> <span class="kw">SET</span> MESSAGE_TEXT <span class="op">=</span> <span class="st">&#39;Problème: pas assez de places disponibles.&#39;</span>;</span></code></pre></div>
<div class="sourceCode" id="cb19"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">DROP</span> <span class="kw">PROCEDURE</span> <span class="cf">IF</span> <span class="kw">EXISTS</span> sp_commande_spectacle ;</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>DELIMITER <span class="op">//</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">PROCEDURE</span> sp_commande_spectacle(<span class="kw">IN</span> p_nb_places <span class="dt">INT</span>, <span class="kw">IN</span> p_client_id <span class="dt">INT</span>, <span class="kw">IN</span> p_spectacle_id <span class="dt">INT</span>)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="kw">START</span> <span class="kw">TRANSACTION</span>;</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="co">-- à compléter</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="co">-- à compléter</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="co">-- à compléter</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="co">-- à compléter</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a><span class="kw">COMMIT</span>;</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>; <span class="op">//</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>DELIMITER ;</span></code></pre></div>
<div class="sourceCode" id="cb20"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> td_Spectacle;</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> td_Client;</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> td_Journal;</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="kw">CALL</span> sp_commande_spectacle(<span class="dv">25</span>,<span class="dv">1</span>,<span class="dv">1</span>);</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> td_Spectacle;</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> td_Client;</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> td_Journal;</span></code></pre></div>
<p><a
href="https://stackoverflow.com/questions/6121917/automatic-rollback-if-commit-transaction-is-not-reached"
target="_blanck">https://stackoverflow.com/questions/6121917/automatic-rollback-if-commit-transaction-is-not-reached</a>
<br> <a
href="https://khanrahim.wordpress.com/2010/05/16/transaction-with-stored-procedure-in-mysql-server/"
target="_blanck">https://khanrahim.wordpress.com/2010/05/16/transaction-with-stored-procedure-in-mysql-server/</a></p>
<div class="sourceCode" id="cb21"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> exit handler <span class="cf">for</span> sqlexception</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">BEGIN</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ROLLBACK</span>;</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> exit handler <span class="cf">for</span> sqlwarning</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a> <span class="cf">BEGIN</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a> <span class="kw">ROLLBACK</span>;</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<p>CREATE DEFINER=<code>##</code>@<code>%</code> PROCEDURE
sp_commande_spectacle(IN nb_places INT, IN client_id INT, IN
spectacle_id INT)</p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">DROP</span> <span class="kw">PROCEDURE</span> <span class="cf">IF</span> <span class="kw">EXISTS</span> sp_commande_spectacle ;</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>DELIMITER <span class="op">//</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">PROCEDURE</span> sp_commande_spectacle(<span class="kw">IN</span> p_nb_places <span class="dt">INT</span>, <span class="kw">IN</span> p_client_id <span class="dt">INT</span>, <span class="kw">IN</span> p_spectacle_id <span class="dt">INT</span>)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> exit handler <span class="cf">for</span> sqlexception</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">BEGIN</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ROLLBACK</span>;</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>  SIGNAL SQLSTATE <span class="st">&#39;45000&#39;</span> <span class="kw">SET</span> MESSAGE_TEXT <span class="op">=</span> <span class="st">&#39;SQLError occured. Procedure error ROLLBACK&#39;</span>;</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> exit handler <span class="cf">for</span> sqlwarning</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a> <span class="cf">BEGIN</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a> <span class="kw">ROLLBACK</span>;</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a> SIGNAL SQLSTATE <span class="st">&#39;35000&#39;</span> <span class="kw">SET</span> MESSAGE_TEXT <span class="op">=</span> <span class="st">&#39;SQLwarning occured. Procedure warning ROLLBACK&#39;</span>;</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a><span class="kw">START</span> <span class="kw">TRANSACTION</span>;</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a><span class="co">-- à compléter</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a><span class="co">-- à compléter</span></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a><span class="co">-- à compléter</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a><span class="co">-- à compléter</span></span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a><span class="kw">COMMIT</span>;</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>; <span class="op">//</span></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>DELIMITER ;</span></code></pre></div>
<h1 id="trigger">trigger</h1>
<p>Dans MySQL, un <strong>trigger</strong> (ou déclencheur) est une
commande SQL définie par l’utilisateur qui est automatiquement invoquée
lors d’une opération <strong>INSERT, DELETE ou UPDATE</strong>. Le code
trigger est associé à une table et est détruit une fois que la table est
<strong>supprimée</strong>.</p>
<p>un trigger, c’est quoi ?<a
href="https://www.w3resource.com/mysql/mysql-triggers.php"
target="_blanck">https://www.w3resource.com/mysql/mysql-triggers.php</a>
<br> présentation (<a
href="https://www.digitalocean.com/community/tutorials/how-to-manage-and-use-mysql-database-triggers-on-ubuntu-18-04-fr"
target="_blanck">voir article</a>)</p>
<div class="sourceCode" id="cb23"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>DELIMITER <span class="op">//</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TRIGGER</span> [TRIGGER_NAME]</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>[<span class="kw">TRIGGER</span> <span class="dt">TIME</span>] [<span class="kw">TRIGGER</span> EVENT]</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="kw">ON</span> [<span class="kw">TABLE</span>]</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="cf">FOR</span> <span class="kw">EACH</span> <span class="kw">ROW</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>[<span class="kw">TRIGGER</span> <span class="kw">BODY</span>]<span class="op">//</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>DELIMITER ;</span></code></pre></div>
<p>exemple :</p>
<div class="sourceCode" id="cb24"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>DELIMITER #</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TRIGGER</span> trigger_CLIENT_insert_before</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="kw">BEFORE</span> <span class="kw">INSERT</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="kw">ON</span> td_Client</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="cf">FOR</span> <span class="kw">EACH</span> <span class="kw">ROW</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="cf">IF</span> <span class="kw">NEW</span>.nom<span class="op">=</span><span class="st">&#39;&#39;</span> <span class="cf">THEN</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    SIGNAL SQLSTATE <span class="st">&#39;45000&#39;</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SET</span> MESSAGE_TEXT <span class="op">=</span> <span class="st">&#39;Le nom ne peut pas etre une chaine vide&#39;</span>;</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span> <span class="cf">IF</span>;    </span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>; #</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>DELIMITER ;</span></code></pre></div>
<p>autre solution</p>
<div class="sourceCode" id="cb25"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="cf">IF</span> <span class="kw">NEW</span>.nom<span class="op">=</span><span class="st">&#39;&#39;</span> <span class="cf">THEN</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    SIGNAL SQLSTATE <span class="st">&#39;45000&#39;</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SET</span> MESSAGE_TEXT <span class="op">=</span> <span class="st">&#39;Le nom ne peut pas etre une chaine vide&#39;</span>;</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="cf">ELSE</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SET</span> <span class="kw">NEW</span>.nom<span class="op">=</span><span class="fu">LOWER</span>(<span class="kw">NEW</span>.nom);</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span> <span class="cf">IF</span>;</span></code></pre></div>
<p>pour tester</p>
<div class="sourceCode" id="cb26"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>SHOW <span class="kw">TRIGGERS</span>;</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> td_Client;</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">into</span> td_Client <span class="kw">VALUES</span> (<span class="dv">3</span>, <span class="st">&#39;SEBastien&#39;</span>, <span class="dv">0</span>, <span class="dv">350</span>);</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">into</span> td_Client <span class="kw">VALUES</span> (<span class="dv">4</span>, <span class="st">&#39;&#39;</span>, <span class="dv">0</span>, <span class="dv">350</span>);</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> td_Client;</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="kw">DROP</span> <span class="kw">TRIGGER</span> trigger_CLIENT_insert_before;</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="kw">DELETE</span> <span class="kw">FROM</span> td_Client <span class="kw">WHERE</span> id_client<span class="op">&gt;</span><span class="dv">2</span>;</span></code></pre></div>
<p><a
href="https://stackoverflow.com/questions/5271997/trigger-syntax-and-if-else-then"
target="_blanck">autre exemple</a></p>
<ul>
<li>exercice : trigger ; fonctionnalité : lors d’une mise à jour de
client mettre le nom en MAJUSCULE</li>
</ul>
<div class="sourceCode" id="cb27"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">DROP</span> <span class="kw">TABLE</span> <span class="cf">IF</span> <span class="kw">EXISTS</span> td_log_client_update;</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> td_log_client_update (</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">id</span> <span class="dt">INTEGER</span>  AUTO_INCREMENT,</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    client_id <span class="dt">INTEGER</span>,</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    updated_date  DATETIME,</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    updated_by <span class="dt">VARCHAR</span>(<span class="dv">255</span>),</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">PRIMARY</span> <span class="kw">KEY</span> (<span class="kw">id</span>)</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>);</span></code></pre></div>
<div class="sourceCode" id="cb28"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">DROP</span> <span class="kw">TRIGGER</span> td_Client_after_update;</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>DELIMITER <span class="op">//</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TRIGGER</span> td_Client_after_update</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="kw">AFTER</span> <span class="kw">UPDATE</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>   <span class="kw">ON</span> td_Client <span class="cf">FOR</span> <span class="kw">EACH</span> <span class="kw">ROW</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>   <span class="kw">DECLARE</span> vUser <span class="dt">varchar</span>(<span class="dv">50</span>);</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>   <span class="co">-- Find username of person performing the INSERT into table</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>   <span class="kw">SELECT</span> <span class="fu">USER</span>() <span class="kw">INTO</span> vUser;</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>   <span class="co">-- Insert record into audit table</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a><span class="co">-- à compléter</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a><span class="co">-- à compléter</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>; <span class="op">//</span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>DELIMITER ;</span></code></pre></div>
<div class="sourceCode" id="cb29"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">UPDATE</span> td_Client <span class="kw">SET</span> nom<span class="op">=</span><span class="st">&#39;SEBastien&#39;</span> , nb_places_reservees <span class="op">=</span> nb_places_reservees <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> id_client<span class="op">=</span><span class="dv">1</span>;</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> td_Client;</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> td_log_client_update;</span></code></pre></div>
<div class="sourceCode" id="cb30"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="cf">IF</span> <span class="kw">NEW</span>.nom<span class="op">=</span><span class="st">&#39;&#39;</span> <span class="cf">THEN</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    SIGNAL SQLSTATE <span class="st">&#39;45000&#39;</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SET</span> MESSAGE_TEXT <span class="op">=</span> <span class="st">&#39;Le nom ne peut pas etre une chaine vide&#39;</span>;</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="cf">ELSE</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="co">-- à compléter</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="co">-- à compléter</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span> <span class="cf">IF</span>;</span></code></pre></div>
<p><a
href="https://www.orleans-informatique.com/info/sio/exercices/TP%20N%C2%B05%20-%20SQL%20et%20triggers.pdf"
target="_blanck">https://www.orleans-informatique.com/info/sio/exercices/TP%20N%C2%B05%20-%20SQL%20et%20triggers.pdf</a>
<br></p>
<p><a
href="https://www.orleans-informatique.com/etudiants/informatique/bts-sio/sql-conception-base-donnees"
target="_blanck">https://www.orleans-informatique.com/etudiants/informatique/bts-sio/sql-conception-base-donnees</a>
<br></p>
<p><a
href="https://cours-info.iut-bm.univ-fcomte.fr/upload/perso/77/rs_S2_BDD/tp/ressources/BTS_TP_5_SQL_triggers_corrige.pdf"
target="_blanck">exemples</a> <br> <br><br><br> <br> <!--
# annexe : solution


code de la transaction

```sql
UPDATE td_Client SET nb_places_reservees = nb_places_reservees + @nb_place WHERE id_client=@client_id;
UPDATE td_Spectacle SET nb_places_libres = nb_places_libres - @nb_place WHERE id_spectacle=@spectacle_id;

SELECT @prix:=@nb_place*tarif
FROM td_Spectacle 
WHERE  id_spectacle=@spectacle_id;

INSERT td_Journal VALUES (NULL,'achat de place',@client_id,@nb_place,@spectacle_id,@prix);
```

code dans la procédure pour la transaction

```sql
UPDATE td_Client SET nb_places_reservees = nb_places_reservees + s_nb_places WHERE id_client=s_client_id;
UPDATE td_Spectacle SET nb_places_libres = nb_places_libres - s_nb_places WHERE id_spectacle=s_spectacle_id;

SELECT @prix:=s_nb_places*tarif
FROM td_Spectacle 
WHERE  id_spectacle=s_spectacle_id;

INSERT td_Journal VALUES (NULL,'achat de place',s_client_id,s_nb_places,s_spectacle_id,@prix);
```






* exercice : trigger

```sql

   -- Insert record into audit table
   INSERT INTO td_log_client_update
   ( client_id,
     updated_date,
     updated_by)
   VALUES
   ( NEW.id_client,
     SYSDATE(),
     vUser );
```
--></p>
<!--   
print in mysql

https://stackoverflow.com/questions/3314771/print-debugging-info-from-stored-procedure-in-mysql

CREATE PROCEDURE procedure_name() 
BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        SHOW ERRORS;  --this is the only one which you need
        ROLLBACK;   
    END; 
    START TRANSACTION;
        --query 1
        --query 2
        --query 3
    COMMIT;
END 
-->
</body>
</html>
