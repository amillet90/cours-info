<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>BDD</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="markdown-pandoc-amV4.css" />
  <link rel="icon" href="favicon.ico" />
  <title>BDD</title>
</head>
<body>
<h1 id="jointure-relationnelle">jointure relationnelle</h1>
<p>Dans une requête, si les noms de colonnes ne sont pas ambiguës, il
n’est pas nécessaire de rajouter devant un champ le nom de la
table.<br />
Mais ce n’est pas “propre”, c’est difficile à relire, donc si il y a des
jointures au minimum préfixer le nom des champs par de simple alias pour
savoir à quelle table appartient chaque champ.</p>
<h2 id="jointure-interne">jointure interne</h2>
<p>C’est la jointure par défaut <strong>celle que vous devez maîtriser
parfaitement</strong></p>
<p>Il existe 2 manières de réaliser (écrire) une jointure interne :</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">&lt;</span>fields<span class="op">&gt;</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> TableA </span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>[<span class="kw">INNER</span>] <span class="kw">JOIN</span> TableB  <span class="kw">ON</span> TableA.PrimaryKey <span class="op">=</span> TableB.ForeignKey;</span></code></pre></div>
<ul>
<li>ancienne notation</li>
</ul>
<div class="sourceCode" id="cb2"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">&lt;</span>fields<span class="op">&gt;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> TableA , TableB </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> TableA.PrimaryKey <span class="op">=</span> TableB.ForeignKey;</span></code></pre></div>
<p>La première méthode d’écrire une jointure avec “INNER JOIN” est
recommandée bien que un peu plus difficile à écrire au début, elle est
plus normalisée plus rapide pour les moteurs de SGBDR. <strong>C’est
cette méthode que vous devez privilégier</strong>.</p>
<p>Si les clés dans les tables portent le même nom, avec le mot clé <a
href="http://sql.sh/cours/jointures/natural-join">NATURAL</a>, il est
possible de définir la jointure sans utiliser le mot clé “ON” (à titre
d’information, éviter cette notation).</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">&lt;</span>fields<span class="op">&gt;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> TableA </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="kw">NATURAL</span> <span class="kw">JOIN</span> TableB;</span></code></pre></div>
<p>Les Différents types de jointures :</p>
<figure>
<img src="img/BDD2_td5_img1.png" alt="jointures SQL" />
<figcaption aria-hidden="true">jointures SQL</figcaption>
</figure>
<ul>
<li>équijointure non-équijointure : pour l’équijointure la comparaison
des clés se fait avec une égalité</li>
<li>les jointures internes sont les jointures naturelles</li>
<li>les jointures externes (droite gauche) permettent de rajouter les
champs quand une des clés est “NULL”</li>
<li>les autres cas sont très peu utilisés et peuvent être réalisés sur
MYSQL grâce à l’opérateur UNION (qui est vu dans la suite du TD)</li>
</ul>
<p>Créer les 2 tables ci dessous :</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">DROP</span> <span class="kw">TABLE</span> <span class="cf">IF</span> <span class="kw">EXISTS</span> TD_EMPLOYE,TD_DEPARTEMENT;</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span>  TD_DEPARTEMENT (</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    idDept <span class="dt">INT</span>,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    nom <span class="dt">VARCHAR</span>(<span class="dv">255</span>),</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    lieu <span class="dt">VARCHAR</span>(<span class="dv">255</span>),</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">PRIMARY</span> <span class="kw">KEY</span>(idDept)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> TD_DEPARTEMENT (idDept,nom,lieu)  <span class="kw">VALUES</span> (<span class="dv">10</span>,<span class="ot">&quot;recherche&quot;</span>,<span class="ot">&quot;Besançon&quot;</span>);</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> TD_DEPARTEMENT (idDept,nom,lieu)  <span class="kw">VALUES</span> (<span class="dv">20</span>,<span class="ot">&quot;vente&quot;</span>,<span class="ot">&quot;Montbéliard&quot;</span>);</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> TD_DEPARTEMENT (idDept,nom,lieu)  <span class="kw">VALUES</span> (<span class="dv">30</span>,<span class="ot">&quot;direction&quot;</span>,<span class="ot">&quot;Belfort&quot;</span>);</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> TD_DEPARTEMENT (idDept,nom,lieu)  <span class="kw">VALUES</span> (<span class="dv">40</span>,<span class="ot">&quot;fabrication&quot;</span>,<span class="ot">&quot;Sochaux&quot;</span>);</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span>  TD_EMPLOYE (</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    idEmploye <span class="dt">INT</span>,</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    nom <span class="dt">VARCHAR</span>(<span class="dv">255</span>),</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    fonction <span class="dt">VARCHAR</span>(<span class="dv">255</span>),</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    idResponsable <span class="dt">INT</span>,</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    date_embauche <span class="dt">date</span>,</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    salaire <span class="dt">NUMERIC</span>(<span class="dv">8</span>,<span class="dv">2</span>),</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    prime <span class="dt">NUMERIC</span>(<span class="dv">8</span>,<span class="dv">2</span>),</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    departement_id <span class="dt">INT</span>,</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">PRIMARY</span> <span class="kw">KEY</span>(idEmploye)</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> TD_EMPLOYE(nom,idEmploye,fonction,idResponsable,date_embauche,salaire,prime,departement_id) <span class="kw">VALUES</span> </span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>(<span class="st">&#39;MARTIN&#39;</span>,<span class="dv">16712</span>,<span class="st">&#39;directeur&#39;</span>,<span class="dv">25717</span>,<span class="st">&#39;2000-05-23&#39;</span>,<span class="dv">8000</span>,<span class="kw">NULL</span>,<span class="dv">30</span>);</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> TD_EMPLOYE(nom,idEmploye,fonction,idResponsable,date_embauche,salaire,prime,departement_id) <span class="kw">VALUES</span> </span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>(<span class="st">&#39;DUPONT&#39;</span>,<span class="dv">17574</span>,<span class="st">&#39;administratif&#39;</span>,<span class="dv">16712</span>,<span class="st">&#39;2005-05-03&#39;</span>,<span class="dv">1800</span>,<span class="kw">NULL</span>,<span class="dv">30</span>),</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>(<span class="st">&#39;DUPOND&#39;</span>,<span class="dv">26691</span>,<span class="st">&#39;commercial&#39;</span>,<span class="dv">27047</span>,<span class="st">&#39;1998-04-04&#39;</span>,<span class="dv">5000</span>,<span class="dv">500</span>,<span class="dv">20</span>),</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>(<span class="st">&#39;LAMBERT&#39;</span>,<span class="dv">25012</span>,<span class="st">&#39;administratif&#39;</span>,<span class="dv">27047</span>,<span class="st">&#39;2001-03-14&#39;</span>,<span class="kw">NULL</span>,<span class="dv">2400</span>,<span class="dv">20</span>),</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>(<span class="st">&#39;JOUBERT&#39;</span>,<span class="dv">25717</span>,<span class="st">&#39;president&#39;</span>,<span class="kw">NULL</span>,<span class="st">&#39;1992-08-10&#39;</span>,<span class="dv">10000</span>,<span class="kw">NULL</span>,<span class="dv">30</span>),</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>(<span class="st">&#39;LEBRETON&#39;</span>,<span class="dv">16034</span>,<span class="st">&#39;commercial&#39;</span>,<span class="dv">27047</span>,<span class="st">&#39;2001-06-01&#39;</span>,<span class="dv">3000</span>,<span class="dv">0</span>,<span class="dv">20</span>),</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>(<span class="st">&#39;MARTIN&#39;</span>,<span class="dv">17147</span>,<span class="st">&#39;commercial&#39;</span>,<span class="dv">27047</span>,<span class="st">&#39;2005-05-03&#39;</span>,<span class="dv">4000</span>,<span class="dv">500</span>,<span class="dv">20</span>),</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>(<span class="st">&#39;PAQUEL&#39;</span>,<span class="dv">27546</span>,<span class="st">&#39;commercial&#39;</span>,<span class="dv">27047</span>,<span class="st">&#39;1993-09-03&#39;</span>,<span class="dv">4400</span>,<span class="dv">1000</span>,<span class="dv">20</span>),</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>(<span class="st">&#39;LEFEBVRE&#39;</span>,<span class="dv">25935</span>,<span class="st">&#39;commercial&#39;</span>,<span class="dv">27047</span>,<span class="st">&#39;1994-01-11&#39;</span>,<span class="dv">4700</span>,<span class="dv">400</span>,<span class="dv">20</span>),</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>(<span class="st">&#39;GARDARIN&#39;</span>,<span class="dv">15155</span>,<span class="st">&#39;ingenieur&#39;</span>,<span class="dv">24533</span>,<span class="st">&#39;1995-03-22&#39;</span>,<span class="dv">4800</span>,<span class="kw">NULL</span>,<span class="dv">10</span>),</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>(<span class="st">&#39;SIMON&#39;</span>,<span class="dv">26834</span>,<span class="st">&#39;ingenieur&#39;</span>,<span class="dv">24533</span>,<span class="st">&#39;1998-10-04&#39;</span>,<span class="dv">4000</span>,<span class="kw">NULL</span>,<span class="dv">10</span>),</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>(<span class="st">&#39;DELOBEL&#39;</span>,<span class="dv">16278</span>,<span class="st">&#39;ingenieur&#39;</span>,<span class="dv">24533</span>,<span class="st">&#39;2004-11-16&#39;</span>,<span class="dv">4200</span>,<span class="kw">NULL</span>,<span class="dv">10</span>),</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>(<span class="st">&#39;ADIBA&#39;</span>,<span class="dv">25067</span>,<span class="st">&#39;ingenieur&#39;</span>,<span class="dv">24533</span>,<span class="st">&#39;1997-10-05&#39;</span>,<span class="dv">6000</span>,<span class="kw">NULL</span>,<span class="dv">10</span>),</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>(<span class="st">&#39;CODD&#39;</span>,<span class="dv">24533</span>,<span class="st">&#39;directeur&#39;</span>,<span class="dv">25717</span>,<span class="st">&#39;1985-11-12&#39;</span>,<span class="dv">11000</span>,<span class="kw">NULL</span>,<span class="dv">10</span>),</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>(<span class="st">&#39;LAMERE&#39;</span>,<span class="dv">27047</span>,<span class="st">&#39;directeur&#39;</span>,<span class="dv">25717</span>,<span class="st">&#39;1999-09-07&#39;</span>,<span class="dv">9000</span>,<span class="kw">NULL</span>,<span class="dv">20</span>),</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>(<span class="st">&#39;BALIN&#39;</span>,<span class="dv">17232</span>,<span class="st">&#39;administratif&#39;</span>,<span class="dv">24533</span>,<span class="st">&#39;1997-10-03&#39;</span>,<span class="dv">2700</span>,<span class="kw">NULL</span>,<span class="dv">10</span>),</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>(<span class="st">&#39;BARA&#39;</span>,<span class="dv">24831</span>,<span class="st">&#39;administratif&#39;</span>,<span class="dv">16712</span>,<span class="st">&#39;1998-11-10&#39;</span>,<span class="dv">3000</span>,<span class="kw">NULL</span>,<span class="dv">30</span>),</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>(<span class="st">&#39;toto&#39;</span>,<span class="st">&#39;00001&#39;</span>,<span class="st">&#39;livreur de pizzas&#39;</span>,<span class="kw">NULL</span>,<span class="kw">NULL</span>,<span class="kw">NULL</span>,<span class="kw">NULL</span>,<span class="kw">NULL</span>);</span></code></pre></div>
<p><strong>EXERCICES : les différents cas vont être présentés à l’aide
d’exemples</strong></p>
<h2 id="jointure">jointure</h2>
<ul>
<li>R1 : Réaliser la jointure entre les 2 tables et afficher le nom, la
fonction et le département de chaque employé (avec INNER JOIN)</li>
<li>R2 : Réaliser la même requête avec la deuxième écriture (sans INNER
JOIN) ; ancienne notation moins performante</li>
</ul>
<p>Dans les 2 requêtes, <strong>le résultat sera trié selon l’ordre
lexicographique sur le nom de département puis le nom
d’employé</strong></p>
<pre><code>+----------+---------------+----------------+
| nom      | fonction      | nomDepartement |
+----------+---------------+----------------+
| BARA     | administratif | direction      |
| DUPONT   | administratif | direction      |
| JOUBERT  | president     | direction      |
| MARTIN   | directeur     | direction      |
| ADIBA    | ingenieur     | recherche      |
| BALIN    | administratif | recherche      |
| CODD     | directeur     | recherche      |
| DELOBEL  | ingenieur     | recherche      |
| GARDARIN | ingenieur     | recherche      |
| SIMON    | ingenieur     | recherche      |
| DUPOND   | commercial    | vente          |
| LAMBERT  | administratif | vente          |
| LAMERE   | directeur     | vente          |
| LEBRETON | commercial    | vente          |
| LEFEBVRE | commercial    | vente          |
| MARTIN   | commercial    | vente          |
| PAQUEL   | commercial    | vente          |
+----------+---------------+----------------+</code></pre>
<p><strong>Utiliser dans la suite le mot clé JOIN pour vos
jointures</strong></p>
<ul>
<li><p>R3 : refaire la même chose avec une jointure externe à droite et
à gauche</p></li>
<li><p>Quelle est la différence avec le résultat précédent ?</p></li>
<li><p>R4 : afficher le nombre d’employés par département</p></li>
</ul>
<pre><code>+----------------+----------------+
| NombreEmployes | nomDepartement |
+----------------+----------------+
|              4 | direction      |
|              6 | recherche      |
|              7 | vente          |
+----------------+----------------+</code></pre>
<ul>
<li>ajouter le lieu</li>
</ul>
<pre><code>+----------------+----------------+--------------+
| NombreEmployes | nomDepartement | lieu         |
+----------------+----------------+--------------+
|              4 | direction      | Belfort      |
|              6 | recherche      | Besançon     |
|              7 | vente          | Montbéliard  |
+----------------+----------------+--------------+</code></pre>
<ul>
<li>PROVOQUER une erreur de type <code>ONLY_FULL_GROUP_BY</code> ;
Regarder la valeur de la variable <code>@@sql_mode</code> ; ajouter puis
retirer le mode <code>ONLY_FULL_GROUP_BY</code></li>
</ul>
<pre><code>SELECT @@sql_mode ;



-- ajouter le mode
SET sql_mode=(SELECT CONCAT(@@sql_mode,&#39;,ONLY_FULL_GROUP_BY&#39;));
-- supprimer le mode
SET sql_mode=(SELECT REPLACE(@@sql_mode, &#39;ONLY_FULL_GROUP_BY&#39;, &#39;&#39;));</code></pre>
<p>ne pas faire <code>SET sql_mode = '';</code> ; conséquence =&gt; <a
href="https://dev.mysql.com/doc/refman/8.0/en/sql-mode.html"
target="_blanck">https://dev.mysql.com/doc/refman/8.0/en/sql-mode.html</a><br />
voir <a
href="https://stackoverflow.com/questions/34115174/error-related-to-only-full-group-by-when-executing-a-query-in-mysql"
target="_blanck">config sql_mode</a><br />
<br> <br></p>
<ul>
<li><strong>R5</strong> : Refaire la même chose avec une jointure
externe à droite et à gauche</li>
<li>Comment doit être la jointure pour obtenir le résultat ci dessous
:</li>
</ul>
<pre><code>+---------------+-------------+
| NombreEmploye | nom         |
+---------------+-------------+
|             4 | direction   |
|             0 | fabrication |
|             6 | recherche   |
|             7 | vente       |
+---------------+-------------+</code></pre>
<ul>
<li><strong>R6</strong> : Retrouver les départements n’ayant aucun
employé.</li>
</ul>
<pre><code>+-------------+
| nom         |
+-------------+
| fabrication |
+-------------+
+---------------+-------------+
| NombreEmploye | nom         |
+---------------+-------------+
|             0 | fabrication |
+---------------+-------------+</code></pre>
<h2 id="jointure-dune-table-à-elle-même">Jointure d’une table à
elle-même</h2>
<ul>
<li><strong>R7</strong> : Donner pour chaque employé le nom de son
supérieur hiérarchique.</li>
</ul>
<p><strong>le résultat sera trié selon l’ordre lexicographique sur la
fonction du responsable puis le nom du responsable puis la fonction de
l’employé puis le nom de l’employé</strong></p>
<pre><code>+----------+---------------+----------------+---------------------+
| nom      | fonction      | nomResponsable | FonctionResponsable |
+----------+---------------+----------------+---------------------+
| BALIN    | administratif | CODD           | directeur           |
| ADIBA    | ingenieur     | CODD           | directeur           |
| DELOBEL  | ingenieur     | CODD           | directeur           |
| GARDARIN | ingenieur     | CODD           | directeur           |
| SIMON    | ingenieur     | CODD           | directeur           |
| LAMBERT  | administratif | LAMERE         | directeur           |
| DUPOND   | commercial    | LAMERE         | directeur           |
| LEBRETON | commercial    | LAMERE         | directeur           |
| LEFEBVRE | commercial    | LAMERE         | directeur           |
| MARTIN   | commercial    | LAMERE         | directeur           |
| PAQUEL   | commercial    | LAMERE         | directeur           |
| BARA     | administratif | MARTIN         | directeur           |
| DUPONT   | administratif | MARTIN         | directeur           |
| CODD     | directeur     | JOUBERT        | president           |
| LAMERE   | directeur     | JOUBERT        | president           |
| MARTIN   | directeur     | JOUBERT        | president           |
+----------+---------------+----------------+---------------------+</code></pre>
<ul>
<li><strong>R8</strong> : Donner pour chaque employé le nom de son
supérieur hiérarchique avec un supérieur hiérarchique qui n’a pas de
supérieur.</li>
</ul>
<pre><code>+--------+-----------+----------------+---------------------+
| nom    | fonction  | nomResponsable | FonctionResponsable |
+--------+-----------+----------------+---------------------+
| MARTIN | directeur | JOUBERT        | president           |
| CODD   | directeur | JOUBERT        | president           |
| LAMERE | directeur | JOUBERT        | president           |
+--------+-----------+----------------+---------------------+</code></pre>
<h2
id="non-équijointure-la-jointure-nutilise-pas-entre-les-2-clés">non-équijointure
(la jointure n’utilise pas “=” entre les 2 clés)</h2>
<ul>
<li><strong>R9</strong> : Quels sont les employés gagnant plus que SIMON
?</li>
</ul>
<pre><code>+----------+------------+----------+
| nom      | fonction   | salaire  |
+----------+------------+----------+
| GARDARIN | ingenieur  |  4800.00 |
| DELOBEL  | ingenieur  |  4200.00 |
| MARTIN   | directeur  |  8000.00 |
| CODD     | directeur  | 11000.00 |
| ADIBA    | ingenieur  |  6000.00 |
| JOUBERT  | president  | 10000.00 |
| LEFEBVRE | commercial |  4700.00 |
| DUPOND   | commercial |  5000.00 |
| LAMERE   | directeur  |  9000.00 |
| PAQUEL   | commercial |  4400.00 |
+----------+------------+----------+</code></pre>
<h1 id="les-sous-interrogations">Les sous-interrogations</h1>
<p>Une caractéristique puissante de SQL est la possibilité qu’un critère
de recherche employé dans une clause WHERE (expression à droite d’un
opérateur de comparaison) soit lui-même le résultat d’un SELECT ; c’est
ce qu’on appelle une sous-interrogation.</p>
<p><a
href="https://dev.mysql.com/doc/refman/5.7/en/any-in-some-subqueries.html"
class="uri">https://dev.mysql.com/doc/refman/5.7/en/any-in-some-subqueries.html</a></p>
<p>Remarque : Tout ces cas ne sont pas à connaître par cœur mais
l’objectif est de vous montrer la complexité possible de certaines
requêtes faites avec un SELECT</p>
<h2 id="sous-interrogation-ramenant-une-seule-valeur">Sous-interrogation
ramenant une seule valeur</h2>
<p><strong>R10</strong> : Quels sont les employés ayant la même fonction
que “codd” ?</p>
<pre><code>+--------+-----------+----------+---------------+
| nom    | fonction  | salaire  | idResponsable |
+--------+-----------+----------+---------------+
| MARTIN | directeur |  8000.00 |         25717 |
| CODD   | directeur | 11000.00 |         25717 |
| LAMERE | directeur |  9000.00 |         25717 |
+--------+-----------+----------+---------------+</code></pre>
<p><strong>R11</strong> : Liste des employés gagnant plus que la moyenne
des salaires.</p>
<pre><code>+---------+-----------+----------+
| nom     | fonction  | salaire  |
+---------+-----------+----------+
| MARTIN  | directeur |  8000.00 |
| CODD    | directeur | 11000.00 |
| ADIBA   | ingenieur |  6000.00 |
| JOUBERT | president | 10000.00 |
| LAMERE  | directeur |  9000.00 |
+---------+-----------+----------+</code></pre>
<p>Remarques :</p>
<ul>
<li>Une sous-interrogation qui ne ramène aucune ligne se termine avec un
code d’erreur.</li>
<li>Une sous-interrogation ramenant plusieurs lignes provoquera aussi,
dans ce cas, une erreur (pour traiter correctement ce cas, voir
paragraphe ci-dessous)</li>
</ul>
<h2 id="sous-interrogation-ramenant-plusieurs-lignes">Sous-interrogation
ramenant plusieurs lignes</h2>
<ul>
<li>l’opérateur IN (exemple dernière requête du tp3)</li>
<li>les opérateurs obtenus en ajoutant ANY ou ALL à la suite d’un
opérateur de comparaison classique (=, !=, &gt;, &gt;=, &lt;, &lt;=)
<ul>
<li><strong>ANY</strong>: la comparaison est vraie si elle est vraie
pour au moins un des éléments de l’ensemble. (alias <a
href="https://mariadb.com/kb/en/library/subqueries-and-any/"><strong>some</strong></a>)</li>
<li><strong>ALL</strong>: la comparaison sera vraie si elle est vraie
pour tous les éléments de l’ensemble.</li>
</ul></li>
</ul>
<p><br></p>
<ul>
<li><strong>R12</strong> : Quels sont les employés gagnant plus que tous
les employés du département 20.</li>
<li>Commencer par afficher le salaire minimum dans le département
20</li>
</ul>
<pre><code>+---------+-----------+----------+
| nom     | fonction  | salaire  |
+---------+-----------+----------+
| CODD    | directeur | 11000.00 |
| JOUBERT | president | 10000.00 |
+---------+-----------+----------+</code></pre>
<ul>
<li><strong>R13</strong> : Quels sont les employés gagnant plus que au
moins un employé du département 20 ?</li>
</ul>
<pre><code>+--------------+
| min(salaire) |
+--------------+
|      3000.00 |
+--------------+

+----------+------------+----------+
| nom      | fonction   | salaire  |
+----------+------------+----------+
| GARDARIN | ingenieur  |  4800.00 |
| DELOBEL  | ingenieur  |  4200.00 |
| MARTIN   | directeur  |  8000.00 |
| MARTIN   | commercial |  4000.00 |
| CODD     | directeur  | 11000.00 |
| ADIBA    | ingenieur  |  6000.00 |
| JOUBERT  | president  | 10000.00 |
| LEFEBVRE | commercial |  4700.00 |
| DUPOND   | commercial |  5000.00 |
| SIMON    | ingenieur  |  4000.00 |
| LAMERE   | directeur  |  9000.00 |
| PAQUEL   | commercial |  4400.00 |
+----------+------------+----------+
</code></pre>
<h2
id="sous-interrogation-ramenant-plusieurs-colonnes">Sous-interrogation
ramenant plusieurs colonnes</h2>
<p>Il est possible de comparer le résultat d’un SELECT ramenant
plusieurs colonnes à une liste de colonnes. La liste de colonnes
figurera entre parenthèses à gauche de l’opérateur de comparaison.</p>
<ul>
<li><strong>R14</strong> : Quels sont les employés ayant même fonction
et même supérieur que CODD?</li>
</ul>
<pre><code>+--------+-----------+----------+---------------+
| nom    | fonction  | salaire  | idResponsable |
+--------+-----------+----------+---------------+
| MARTIN | directeur |  8000.00 |         25717 |
| CODD   | directeur | 11000.00 |         25717 |
| LAMERE | directeur |  9000.00 |         25717 |
+--------+-----------+----------+---------------+</code></pre>
<h2
id="sous-interrogation-synchronisée-avec-linterrogation-principale">Sous-interrogation
synchronisée avec l’interrogation principale</h2>
<p>Dans les exemples précédents, la sous-interrogation était évaluée
d’abord, puis le résultat pouvait être utilisé pour exécuter
l’interrogation principale.<br />
SQL sait également traiter une sous-interrogation faisant référence à
une colonne de la table de l’interrogation principale.<br />
Le traitement dans ce cas est plus complexe car il faut évaluer la
sous-interrogation pour chaque ligne de l’interrogation principale.</p>
<ul>
<li><strong>R15</strong> : Quels sont les employés ne travaillant pas
dans le même département que leur supérieur hiérarchique ?</li>
</ul>
<pre><code>+--------+
| nom    |
+--------+
| CODD   |
| LAMERE |
+--------+</code></pre>
<ul>
<li>IS NOT NULL est nécessaire car dans le cas de JOUBERT la colonne
idResponsable est NULL et la sous-requête ne ramène alors aucune
valeur.</li>
</ul>
<h2
id="sous-interrogation-ramenant-au-moins-une-ligne">Sous-interrogation
ramenant au moins une ligne</h2>
<p>L’opérateur <strong>EXISTS</strong> permet de construire un prédicat
vrai si la sous-interrogation qui suit ramène au moins une ligne.</p>
<p><br></p>
<ul>
<li><strong>R16</strong> : Quels sont les employés travaillant dans un
département qui a procédé à des embauches depuis le début de l’année
2005 ?</li>
</ul>
<pre><code>+----------+-----------+---------------+---------------+----------------+
| nom      | idEmploye | fonction      | date_embauche | departement_id |
+----------+-----------+---------------+---------------+----------------+
| LEBRETON |     16034 | commercial    | 2001-06-01    |             20 |
| MARTIN   |     16712 | directeur     | 2000-05-23    |             30 |
| MARTIN   |     17147 | commercial    | 2005-05-03    |             20 |
| DUPONT   |     17574 | administratif | 2005-05-03    |             30 |
| BARA     |     24831 | administratif | 1998-11-10    |             30 |
| LAMBERT  |     25012 | administratif | 2001-03-14    |             20 |
| JOUBERT  |     25717 | president     | 1992-08-10    |             30 |
| LEFEBVRE |     25935 | commercial    | 1994-01-11    |             20 |
| DUPOND   |     26691 | commercial    | 1998-04-04    |             20 |
| LAMERE   |     27047 | directeur     | 1999-09-07    |             20 |
| PAQUEL   |     27546 | commercial    | 1993-09-03    |             20 |
+----------+-----------+---------------+---------------+----------------+
</code></pre>
<h2 id="sous-interrogations-multiples">Sous-interrogations
multiples</h2>
<p>Un SELECT peut comporter plusieurs sous-interrogations, soit
imbriquées, soit au même niveau dans différents prédicats combinés par
des AND ou des OR.</p>
<ul>
<li><strong>R17</strong> : Liste des employés du département 10 ayant
même fonction que quelqu’un du département de DUPONT (le nom fini par un
“T” et son département est 30).
<ul>
<li>Commencer par afficher le département de DUPONT</li>
<li>Afficher la liste des fonctions dans ce département</li>
</ul></li>
</ul>
<pre><code>+-------+---------------+----------------+
| nom   | fonction      | departement_id |
+-------+---------------+----------------+
| BALIN | administratif |             10 |
| CODD  | directeur     |             10 |
+-------+---------------+----------------+</code></pre>
<h1 id="union-requête-ensembliste">UNION (requête ensembliste)</h1>
<ul>
<li>créer les 2 tables ci dessous et tester les requêtes</li>
</ul>
<div class="sourceCode" id="cb22"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">DROP</span> <span class="kw">TABLE</span> <span class="cf">IF</span> <span class="kw">EXISTS</span> TD_CLIENT1,TD_CLIENT2;</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> TD_CLIENT1 (</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    nom <span class="dt">varchar</span>(<span class="dv">30</span>)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> TD_CLIENT1 <span class="kw">VALUES</span> (<span class="st">&#39;nom1&#39;</span>);</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> TD_CLIENT1 <span class="kw">VALUES</span> (<span class="st">&#39;nom2&#39;</span>);</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> TD_CLIENT1 <span class="kw">VALUES</span> (<span class="st">&#39;nom3&#39;</span>);</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> TD_CLIENT2 (</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    nom <span class="dt">varchar</span>(<span class="dv">30</span>)</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> TD_CLIENT2 <span class="kw">VALUES</span> (<span class="st">&#39;nom1&#39;</span>);</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> TD_CLIENT2 <span class="kw">VALUES</span> (<span class="st">&#39;nom2&#39;</span>);</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> TD_CLIENT2 <span class="kw">VALUES</span> (<span class="st">&#39;nom10&#39;</span>);</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> TD_CLIENT2 <span class="kw">VALUES</span> (<span class="st">&#39;nom11&#39;</span>);</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> nom <span class="kw">FROM</span> TD_CLIENT1;</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> nom <span class="kw">FROM</span> TD_CLIENT2;</span></code></pre></div>
<p><br></p>
<div class="sourceCode" id="cb23"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> nom <span class="kw">FROM</span> TD_CLIENT1</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="kw">UNION</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> nom <span class="kw">FROM</span> TD_CLIENT2;</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> nom <span class="kw">FROM</span> TD_CLIENT1</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="kw">UNION</span> <span class="kw">ALL</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> nom <span class="kw">FROM</span> TD_CLIENT2;</span></code></pre></div>
<p><br></p>
<div class="sourceCode" id="cb24"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>                             <span class="co">-- ==&gt; ne fonctionne pas sur MYSQL mais sur ORACLE</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> nom <span class="kw">FROM</span> TD_CLIENT1</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="kw">INTERSECT</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> nom <span class="kw">FROM</span> TD_CLIENT2;   <span class="co">-- (nom1 et nom2)</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="co">-- utiliser IN sur MYSQL</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> nom <span class="kw">FROM</span> TD_CLIENT1</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> nom <span class="kw">IN</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>(<span class="kw">SELECT</span> nom <span class="kw">FROM</span> TD_CLIENT2);</span></code></pre></div>
<p><br></p>
<div class="sourceCode" id="cb25"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>        <span class="co">-- ==&gt; ne fonctionne pas sur MYSQL mais sur ORACLE </span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> nom <span class="kw">FROM</span> TD_CLIENT1</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="kw">EXCEPT</span>              </span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> nom <span class="kw">FROM</span> TD_CLIENT2; <span class="co">-- (nom3)</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="co">-- utiliser NOT IN sur MYSQL</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> nom <span class="kw">FROM</span> TD_CLIENT1</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> nom <span class="kw">NOT</span> <span class="kw">IN</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>(<span class="kw">SELECT</span> nom <span class="kw">FROM</span> TD_CLIENT2);</span></code></pre></div>
<p><br></p>
<ul>
<li>R18 : afficher tous les employés et tous les départements (nom
fonction identifiant du département et nom du département) y compris
ceux qui ont une valeur “identifiant de département” à NULL dans la
table Employe ou les département qui n’ont pas d’employé grâce à une
jointure à droite et à gauche</li>
</ul>
<pre><code>+-------------+--------+----------+-------------------+----------------+
| nom         | idDept | nom      | fonction          | departement_id |
+-------------+--------+----------+-------------------+----------------+
| recherche   |     10 | GARDARIN | ingenieur         |             10 |
....
| direction   |     30 | JOUBERT  | president         |             30 |
| fabrication |     40 | NULL     | NULL              |           NULL |
| NULL        |   NULL | toto     | livreur de pizzas |           NULL |
+-------------+--------+----------+-------------------+----------------+
19 rows in set (0.01 sec)</code></pre>
<h1 id="les-clés-index-ou-key">Les clés : “INDEX” ou “KEY”</h1>
<p>Structure de données qui reprend la liste ordonnée des valeurs
auxquelles il se rapporte. (<a href="https://sql.sh/cours/index"
target="_blanck_">exemple de définition</a>)</p>
<p><br></p>
<p>Lorsque vous créez un index sur une table, MySQL stocke cet index
sous forme d’une structure particulière, contenant les valeurs des
colonnes impliquées dans l’index.</p>
<figure>
<img src="img/BDD2_td5_img2_index.png"
alt="rôle d’un index sur zeste du savoir" />
<figcaption aria-hidden="true">rôle d’un index sur <a
href="https://zestedesavoir.com/tutoriels/730/administrez-vos-bases-de-donnees-avec-mysql/949_index-jointures-et-sous-requetes/3935_index/"
target="_blanck_">zeste du savoir</a></figcaption>
</figure>
<figure>
<img src="img/BDD2_td5_img2_index2.png" style="width:20cm"
alt="structure en arbre et test : sqlshack" />
<figcaption aria-hidden="true">structure en arbre et test : <a
href="https://www.sqlshack.com/sql-server-clustered-indexes-internals-with-examples/"
target="_blanck_">sqlshack</a></figcaption>
</figure>
<p>Création d’un index sur MySql</p>
<div class="sourceCode" id="cb27"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> nom_table (</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    colonne1 description_colonne1,</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    [colonne2 description_colonne2,</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    colonne3 description_colonne3,</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">..</span>.,]</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    [<span class="kw">PRIMARY</span> <span class="kw">KEY</span> (colonne_clé_primaire)],</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    [{<span class="kw">INDEX</span>|<span class="kw">KEY</span>} [nom_index] (colonne1_index [, colonne2_index, <span class="op">..</span>.]],</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    [<span class="kw">UNIQUE</span> [<span class="kw">INDEX</span>|<span class="kw">KEY</span>] [nom_index] (colonne1_index [, colonne2_index, <span class="op">..</span>.]]</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>);</span></code></pre></div>
<p>exemple :</p>
<div class="sourceCode" id="cb28"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>SHOW <span class="kw">CREATE</span> <span class="kw">TABLE</span> TD_EMPLOYE;</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> TD_EMPLOYE <span class="kw">ADD</span> <span class="kw">INDEX</span> `departement_nom_index` (`nom`);</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> TD_EMPLOYE <span class="kw">ADD</span> <span class="kw">INDEX</span> `employe_date_embauche_index` (`date_embauche`);</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>SHOW <span class="kw">CREATE</span> <span class="kw">TABLE</span> TD_EMPLOYE;</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>SHOW <span class="kw">INDEX</span> <span class="kw">FROM</span> TD_EMPLOYE \G</span></code></pre></div>
<p><a
href="https://www.a2hosting.com/kb/developer-corner/mysql/using-indexes-to-improve-mysql-query-performance"
target="_blanck_">Test de performance des INDEX</a></p>
<div class="sourceCode" id="cb29"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">EXPLAIN</span> <span class="kw">SELECT</span> TD_EMPLOYE.nom <span class="kw">FROM</span> TD_EMPLOYE <span class="kw">WHERE</span> fonction <span class="kw">LIKE</span> <span class="st">&#39;d%&#39;</span> <span class="kw">AND</span> date_embauche <span class="op">&gt;=</span><span class="st">&#39;1985-11-12&#39;</span> \G</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="kw">EXPLAIN</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">DISTINCT</span> E1.nom </span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> TD_EMPLOYE E1, TD_DEPARTEMENT D1, TD_EMPLOYE E2, TD_DEPARTEMENT D2</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> E1.departement_id<span class="op">=</span>D1.idDept </span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>       <span class="kw">AND</span> E2.departement_id<span class="op">=</span>D2.idDept </span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="kw">AND</span> D1.nom<span class="op">=</span><span class="st">&#39;vente&#39;</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="kw">AND</span> D2.nom<span class="op">=</span><span class="st">&#39;direction&#39;</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a><span class="kw">AND</span> E1.date_embauche<span class="op">=</span>E2.date_embauche</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>\G</span></code></pre></div>
<p>réflexion sur l’optimisation des requêtes</p>
<ul>
<li><a href="https://sql.sh/optimisation" target="_blanck">conseils
optimisation</a></li>
<li><a
href="https://ircf.fr/actualites/optimiser-votre-base-de-donnees-mysql/"
target="_blanck">conseils optimisation</a></li>
<li><a href="https://buzut.net/maitrisez-mysql-en-cli-avance/"
target="_blanck_">conseils optimisation</a></li>
<li><a href="https://gafish.fr/explain-optimisation-de-requetes-mysql/"
target="_blanck">interprétation EXPLAIN</a></li>
<li><a href="https://buzut.net/optimiser-performances-de-mysql/"
target="_blanck">les variables d’environnement</a></li>
<li><a
href="https://code.tutsplus.com/fr/tutorials/writing-blazing-fast-mysql-queries--cms-25085"
target="_blanck">recherches sur la machine</a></li>
</ul>
<p><br></p>
<ul>
<li>Tracer les requêtes</li>
</ul>
<div class="sourceCode" id="cb30"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>SHOW PROCESSLIST;</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="co">-- ouvrir 2 terminaux connectés à mysql</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> profiling <span class="op">=</span> <span class="dv">1</span>;</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="co">--exécuter une requête</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>SHOW <span class="kw">PROFILE</span>;</span></code></pre></div>
<ul>
<li>Consulter les variables pour voir la charge du serveur (<a
href="https://www.dnsstuff.com/fr/outils-surveillance-bases-de-donnees"
target="_blanck">surveillance des bases de données</a>, équilibrage des
serveurs, supervision, graphique)</li>
</ul>
<p><img src="img/BDD2_td5_img3_opt.png" /></p>
<div class="sourceCode" id="cb31"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>SHOW <span class="kw">GLOBAL</span> STATUS <span class="kw">like</span> <span class="ot">&quot;%used_connections&quot;</span>;</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>show <span class="kw">global</span> status <span class="kw">like</span> <span class="st">&#39;opened_tables&#39;</span>;</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> @@table_open_cache;</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> @@max_connections;</span></code></pre></div>
<p><a href="https://www.altidev.com/livres.php"
target="_blanck_">optimisation du code sur
www.altidev.com/livres.php</a> un <a
href="https://www.altidev.com/images/2412_chap06.pdf"
target="_blanck_">article</a></p>
<h1 id="les-vues">Les VUES</h1>
<p>Les vues permettent d’assurer l’objectif d’indépendance logique.
Grâce à elles, chaque utilisateur pourra avoir sa vision propre des
données.<br />
</p>
<p>On a vu que le résultat d’un SELECT est lui-même une table.<br />
Une telle table, qui n’existe pas dans la base mais est créée
dynamiquement lors de l’exécution du SELECT, peut être vue comme une
table réelle par les utilisateurs. Pour cela, il suffit de cataloguer le
SELECT en tant que vue.<br />
</p>
<p>Les utilisateurs pourront consulter la base, ou modifier la base
(avec certaines restrictions) à travers la vue, c’est-à-dire manipuler
la table résultat du SELECT comme si c’était une table réelle.</p>
<h2 id="créer-une-vue">Créer une vue</h2>
<p>La commande CREATE VIEW permet de créer une vue en spécifiant le
SELECT constituant la définition de la vue :</p>
<pre><code>CREATE VIEW nom_vue [(nom_col1,...)]
AS SELECT ...
[WITH CHECK OPTION] ;</code></pre>
<p>La spécification des noms de colonnes de la vue est facultative. Par
défaut, les noms des colonnes de la vue sont les mêmes que les noms des
colonnes résultat du SELECT (si certaines colonnes résultat du SELECT
sont des expressions, il faut renommer ces colonnes dans le SELECT, ou
spécifier les noms de colonne de la vue).<br />
</p>
<p>Une fois créée, une vue s’utilise comme une table. Il n’y a pas de
duplication des informations mais stockage de la définition de la
vue.<br />
</p>
<p>Exemple : Création d’une vue constituant une restriction de la table
TD_EMPLOYE aux employés du département 10.</p>
<pre><code>CREATE VIEW v_emp10 AS
    SELECT *
    FROM TD_EMPLOYE
    WHERE departement_id = 10 ;

CREATE VIEW v_emp10co AS
    SELECT *
    FROM TD_EMPLOYE
    WHERE departement_id = 10 
WITH CHECK OPTION ;

-- pour les visualiser
SHOW TABLES;</code></pre>
<p>Le CHECK OPTION permet de vérifier que la mise à jour ou l’insertion
faite à travers la vue ne produisent que des lignes qui font partie de
la sélection de la vue.</p>
<p>Ainsi donc, si la vue v_emp10co a été créée avec CHECK OPTION, on ne
pourra à travers cette vue ni modifier, ni insérer des employés ne
faisant pas partie du département 10.</p>
<ul>
<li>Il est possible d’effectuer des INSERT et des UPDATE à travers des
vues, sous deux conditions :
<ul>
<li>Le SELECT définissant la vue ne doit pas comporter de jointure,</li>
<li>les colonnes résultat du SELECT doivent être des colonnes réelles et
non pas des expressions.</li>
</ul></li>
</ul>
<p>Exemple : Modification des salaires du département 10 à travers la
vue v_emp10.</p>
<pre><code>SELECT * FROM v_emp10;
UPDATE v_emp10 SET salaire  = salaire * 1.1;
SELECT * FROM TD_EMPLOYE;</code></pre>
<p>Toutes les lignes de la table TD_EMPLOYE, telles que le contenu de la
colonne departement_id est égal à 10 seront modifiées.</p>
<ul>
<li>autre test :</li>
</ul>
<pre><code>SELECT * FROM v_emp10;
UPDATE v_emp10 SET departement_id=20 where idEmploye=15155;
SELECT * FROM v_emp10;
UPDATE v_emp10 SET departement_id=10 where idEmploye=15155;   
SELECT * FROM v_emp10;   
            --  on ne retrouve plus l&#39;employe GARDARIN !

SELECT * FROM v_emp10co;
UPDATE v_emp10co SET departement_id=20 where idEmploye=26834;   
SELECT * FROM v_emp10co;
UPDATE v_emp10co SET departement_id=10 where idEmploye=26834;</code></pre>
<h2 id="supprimer-une-vue">Supprimer une vue</h2>
<p>Une vue peut être détruite par la commande :</p>
<pre><code>DROP  VIEW nom_vue;</code></pre>
<h2 id="renommer-une-vue">Renommer une vue</h2>
<p>On peut renommer une vue par la commande :</p>
<pre><code>RENAME ancien_nom TO nouveau_nom;</code></pre>
<p><br></p>
<pre><code>DROP  VIEW  v_emp10,v_emp10co;</code></pre>
<p><a
href="http://polymorphe.free.fr/cours/bd/sql/sql_avance/poly_39.html"
target="_blanck_">http://polymorphe.free.fr/cours/bd/sql/sql_avance/poly_39.html</a></p>
<p><a href="https://perso.liris.cnrs.fr/fabien.duchateau/BDW1/"
target="_blanck_">https://perso.liris.cnrs.fr/fabien.duchateau/BDW1/</a></p>
<h1 id="la-suite-supprimer-et-recréer-les-tables">La suite : Supprimer
et recréer les tables</h1>
<hr />
<p>Pour aller plus loin</p>
<ul>
<li>R19 : Donnez les salaire et le nom des employés gagnant plus que
tous les ingénieurs</li>
</ul>
<pre><code>+---------+----------+
| nom     | salaire  |
+---------+----------+
| MARTIN  |  8000.00 |
| CODD    | 11000.00 |
| JOUBERT | 10000.00 |
| LAMERE  |  9000.00 |
+---------+----------+</code></pre>
<p><br></p>
<ul>
<li>R20 : Donnez les noms des employés travaillant dans un département
avec au moins un ingénieur mais qui ne sont pas ingénieur</li>
</ul>
<pre><code>+-------+-----------+---------------+
| nom   | nom       | fonction      |
+-------+-----------+---------------+
| BALIN | recherche | administratif |
| CODD  | recherche | directeur     |
+-------+-----------+---------------+
</code></pre>
<p><br></p>
<ul>
<li>R21 : Donnez les noms des employés du département “vente” embauchés
le même jour qu’un employé du département “direction”</li>
</ul>
<pre><code>+--------+
| nom    |
+--------+
| MARTIN |
+--------+</code></pre>
<p><br></p>
<ul>
<li>R22 : Donnez les noms des employés embauchés avant tous les employés
du département “vente”.</li>
</ul>
<pre><code>+---------+
| nom     |
+---------+
| CODD    |
| JOUBERT |
+---------+</code></pre>
<p><br></p>
<ul>
<li>R23 : Donnez le nom et la date d’embauche des employés embauchés
avant leur responsable; donnez également le nom et la date d’embauche
dudit responsable</li>
</ul>
<pre><code>+----------+---------------+---------+---------------+
| nom      | date_embauche | nom     | date_embauche |
+----------+---------------+---------+---------------+
| CODD     | 1985-11-12    | JOUBERT | 1992-08-10    |
| BARA     | 1998-11-10    | MARTIN  | 2000-05-23    |
| LEFEBVRE | 1994-01-11    | LAMERE  | 1999-09-07    |
| DUPOND   | 1998-04-04    | LAMERE  | 1999-09-07    |
| PAQUEL   | 1993-09-03    | LAMERE  | 1999-09-07    |
+----------+---------------+---------+---------------+
</code></pre>
<p><br></p>
<p><br></p>
<ul>
<li>R24 : Donner les noms des employés ayant le salaire maximum de
chaque département.</li>
</ul>
<pre><code>+---------+----------+
| nom     | salaire  |
+---------+----------+
| CODD    | 11000.00 |
| JOUBERT | 10000.00 |
| LAMERE  |  9000.00 |
+---------+----------+
</code></pre>
<p><br></p>
<ul>
<li>R25 : Le salaire moyen le plus bas (par profession)?</li>
</ul>
<pre><code>+--------------+-------------------+--------------+
| AVG(salaire) | fonction          | min(salaire) |
+--------------+-------------------+--------------+
|  2500.000000 | administratif     |      1800.00 |
|  4220.000000 | commercial        |      3000.00 |
|  9333.333333 | directeur         |      8000.00 |
|  4750.000000 | ingenieur         |      4000.00 |
|         NULL | livreur de pizzas |         NULL |
| 10000.000000 | president         |     10000.00 |
+--------------+-------------------+--------------+</code></pre>
<p><br> R26 : Donner les emplois ayant le salaire moyen le plus bas;
donnez aussi leur salaire moyen.</p>
<pre><code></code></pre>
</body>
</html>
